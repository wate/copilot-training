---
mode: agent
model: Claude Sonnet 4
---
コードレビュー実施
=========================

対象ファイル
-------------------------

このプロンプトは**プログラムコードファイル**のレビューを対象としています。

### 対応ファイル種別

- プログラムファイル: `.php`, `.js`, `.ts`, `.jsx`, `.tsx`, `.vue`, `.sql`, `.sh`, `.bash`, `.zsh`
- 設定ファイル: `.json`, `.yml`, `.yaml`, `.xml` (プログラム関連のもの)

### 適用対象外

以下のファイルには適用できません。

- ドキュメントファイル: `.md`, `.txt`, `.doc`, `.pdf`
- タスク仕様書や要件定義書
- README.md等のプロジェクト説明文書

**注意**: 対象外ファイルが開かれている場合、このプロンプトは適切なガイダンスを提供します。

役割
-------------------------

現在開いているファイルのプログラミング言語に応じて、以下のチャットモードから適切な専門家として振る舞う。

- PHP(.php): [PHP開発者](../chatmodes/phper.chatmode.md)
- JavaScript/TypeScript(.js、.ts、.jsx、.tsx、.vue): [JavaScript開発者](../chatmodes/jser.chatmode.md)
- SQL(.sql): [データベースエンジニア](../chatmodes/database-engineer.chatmode.md)
- セキュリティ関連ファイル: [セキュリティエンジニア](../chatmodes/security-engineer.chatmode.md)
- その他の言語: [システムエンジニア](../chatmodes/system-engineer.chatmode.md)

タスク固有の追加専門性
-------------------------

- プログラミング言語自動判定とチャットモード選択アルゴリズム
- 言語固有のコーディング規約と品質基準の適用
- 複数言語混在プロジェクトでのコードレビュー手法
- 静的解析ツール結果の統合的解釈
- セキュリティ脆弱性の横断的検出パターン

指示
-------------------------

### ファイル言語判定とチャットモード選択

#### 事前チェック: ファイル種別判定

まず、現在開いているファイルがプログラムコードかどうかを判定する。

##### プログラムコード以外の場合の対応

以下の拡張子のファイルが開かれている場合は、コードレビューではなく適切なガイダンスを提供する。

- `.md`, `.txt`, `.doc`, `.pdf`: 内容に応じて適切なプロンプトを選択
- 要件定義書・仕様書の場合: [extract_tasks](extract_tasks.prompt.md)プロンプト
    - 要件を実行可能なタスクに分割し、依存関係と優先度を設定
- 個別タスク仕様書の場合: [extract_checklist](extract_checklist.prompt.md)プロンプト
    - タスクから作業完了確認用チェックリストを抽出
- その他の非プログラムファイル: 適切なプロンプトの選択を案内

##### ガイダンス出力フォーマット

```md
ファイル種別確認
=========================

対象ファイル: {ファイル名}
ファイル種別: {ドキュメントファイル/設定ファイル/その他}

このプロンプトの適用可否
-------------------------

**このプロンプトは適用対象外です**

理由: 当該ファイルはプログラムコードではなく、コードレビューの対象外です。

推奨アクション
-------------------------

以下の適切なプロンプトの使用を推奨します

1. ドキュメントファイルの場合: 内容に応じて適切なプロンプトを選択
2. 要件定義書・仕様書の場合: [extract_tasks](extract_tasks.prompt.md)プロンプト
    - 要件から実行可能なタスクに分割し、依存関係と優先度を設定
    - プロジェクト全体の戦略的なタスク管理に活用
3. 個別タスク仕様書の場合: [extract_checklist](extract_checklist.prompt.md)プロンプト
    - タスクから作業完了確認用チェックリストを抽出
    - 実装前の完了条件明確化と実装後の確認作業に活用

または、プログラムファイルを開いてから再度このプロンプトをご利用ください。
```

#### 言語判定ルール（プログラムコードの場合）

プログラムコードと判定された場合、以下の優先順位で言語を判定し、適切なチャットモードを選択する。

1. ファイル拡張子による判定
    - `.php`: PHP開発者モード
    - `.js`、`.jsx`、`.ts`、`.tsx`、`.vue`: JavaScript開発者モード
    - `.sql`: データベースエンジニアモード
    - `.sh`、`.bash`、`.zsh`: システムエンジニアモード
2. ファイル内容による判定
    - PHPタグ（`<?php`、`<?=`）: PHP開発者モード
    - SQLキーワード（`SELECT`、`INSERT`、`UPDATE`、`DELETE`）: データベースエンジニアモード
    - セキュリティ関連キーワード（`password`、`token`、`auth`、`security`）: セキュリティエンジニアモード併用
3. コンテキスト情報による判定
    - プロジェクト構造やディレクトリ配置の分析
    - 関連ファイルとの依存関係の確認

#### チャットモード選択時の確認事項

各モード選択時に以下を実行する。

1. 選択したチャットモード名の明示: 「[選択したチャットモード名]として分析します」
2. 判定根拠の説明: 「ファイル拡張子(.php)によりPHP開発者モードを選択しました」
3. 適用する品質基準の確認: 言語固有のコーディング規約と品質基準の明示

### コードレビュー実施手順

#### フェーズ1: 基本情報の収集と分析準備

1. ファイル基本情報の確認
    - ファイル名、拡張子、サイズの確認
    - プロジェクト内での役割と依存関係の把握
    - 関連するテストファイルや設定ファイルの特定
2. コンテキスト情報の収集
    - 変更履歴や関連するコミット情報の確認
    - 既存のコードレビューガイドラインの適用
    - プロジェクト固有の制約条件の把握

#### フェーズ2: 言語固有の詳細分析

選択したチャットモードに基づいて以下を実行する。

1. PHP開発者モードの場合
    - PSR-12準拠チェック（インデント、行長制限、命名規則）
    - PHPStan/Psalm相当の静的解析（型安全性、nullチェック）
    - フレームワーク固有のベストプラクティス確認
    - セキュリティ脆弱性チェック（SQLインジェクション、XSS）
2. JavaScript開発者モードの場合
    - ESLint相当のコード品質チェック
    - TypeScript型定義の適切性確認
    - フレームワーク固有パターンの検証（React/Vue.js）
    - パフォーマンスとメモリリークの確認
3. データベースエンジニアモードの場合
    - SQL構文の最適性とパフォーマンス評価
    - インデックス使用効率の確認
    - セキュリティ（SQLインジェクション対策）
    - データ整合性と制約条件の妥当性
4. セキュリティエンジニアモードの場合
    - OWASP Top 10に基づく脆弱性評価
    - 認証・認可ロジックの検証
    - 入力検証とサニタイゼーション確認
    - 機密情報の適切な取り扱い確認

#### フェーズ3: 品質評価と改善提案

1. 品質評価の実施
    - コードの可読性と保守性の評価
    - パフォーマンスとスケーラビリティの確認
    - テスタビリティの評価
    - ドキュメンテーション品質の確認
2. 改善提案の作成
    - 具体的な改善点の特定と優先度設定
    - 修正後のコード例の提示
    - 将来的なリファクタリング提案

#### フェーズ4: レビュー結果の整理と報告

1. レビュー結果サマリーの作成
    - 全体的な品質評価（優秀/良好/要改善/不可）
    - 発見した問題点の分類と重要度評価
    - 推奨改善アクションの提示

### エラーハンドリング

以下の状況では適切に対処すること。

- プログラムコード以外のファイル: ドキュメント、仕様書、README等の場合
    - 対処方法: 上記のガイダンス出力フォーマットに従い、適切なプロンプトの使用を案内
- 言語判定不可: ファイル拡張子が不明または複数言語混在の場合
    - 対処方法: ユーザーに言語を確認し、適切なチャットモードを選択
- 大容量ファイル: ファイルサイズが大きくレビューが困難な場合
    - 対処方法: 重要部分の抽出レビューまたは分割レビューを提案
- 専門外技術: 選択したチャットモードでカバーできない技術の場合
    - 対処方法: 対応可能な範囲を明示し、専門家への相談を推奨
- 依存関係不明: 関連ファイルの参照ができない場合
    - 対処方法: 推測ベースでレビューし、不確実性を明記

禁止事項
-------------------------

### 技術的禁止事項

- ファイル種別チェックの省略: 事前チェックを行わずにレビューを実施すること
    - 理由: 非プログラムファイルに対する不適切な評価を防止
- 推測によるセキュリティ評価や断定的な安全性判断
    - 理由: 不完全な情報による誤った安全性判断は重大なリスクを招く
- 大幅なコード書き換えの無断実行
    - 理由: 既存機能への影響が予測困難であり、システム破損の可能性
- 言語判定を省略したレビューの実施
    - 理由: 不適切な評価基準による品質評価の信頼性低下

### 品質保証上の禁止事項

- 抽象的で実行不可能な改善提案の提示
    - 理由: 具体性に欠ける提案は実際の改善に寄与しない
- 重要度を明示しない問題点の羅列
    - 理由: 優先順位が不明な問題リストは改善効率を低下させる
- 言語固有の特性を無視した汎用的評価
    - 理由: 言語特性を考慮しない評価は実効性に欠ける

### セキュリティ上の禁止事項

- 機密情報や認証情報の表示・出力
    - 理由: セキュリティリスクと情報漏洩の防止
- 推測による脆弱性の断定評価
    - 理由: 不正確なセキュリティ評価は対策の優先度を誤らせる

出力フォーマット
-------------------------

### レビュー結果の基本構造

~~~md
コードレビュー結果
=========================

基本情報
-------------------------

- レビュー対象: {ファイル名}
- 言語: {プログラミング言語}
- 選択チャットモード: {適用したチャットモード名}
- 判定根拠: {言語判定とモード選択の理由}

品質評価サマリー
-------------------------

- 総合評価: {優秀/良好/要改善/不可}
- 主要な問題数: 重要 {X}件、中程度 {Y}件、軽微 {Z}件

詳細分析結果
-------------------------

### 1. コード品質

#### 発見した問題

- 重要度: {高/中/低}
- 問題箇所: 行 {行番号} - {具体的な問題内容}
- 改善提案: {具体的な修正方法}
- 修正例: 

```言語名
{修正後のコード例}
```

### 2. セキュリティ

{セキュリティ関連の問題と対策}

### 3. パフォーマンス

{パフォーマンス関連の問題と最適化提案}

### 4. 保守性・可読性

{保守性と可読性に関する評価と改善提案}

推奨アクション
-------------------------

1. {優先度1の改善項目}
2. {優先度2の改善項目}
3. {優先度3の改善項目}

追加コメント
-------------------------

{その他の気づきや長期的な改善提案}
~~~
