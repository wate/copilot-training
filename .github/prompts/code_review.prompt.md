---
mode: agent
model: Claude Sonnet 4
---
コードレビュー実施
=========================

役割
-------------------------

ファイル拡張子に応じて適切なチャットモードの専門家として振る舞い、コードレビューを実施する。

対象ファイル
-------------------------

- プログラムファイル: `.php`, `.js`, `.mjs`, `.cjs`, `.ts`, `.jsx`, `.tsx`
- 設定ファイル: `.json`, `.yml`, `.yaml` (プログラム関連のもの)

適用対象外: `.md`, `.txt`, `.doc`, `.pdf`等のドキュメントファイル
→ 対象外の場合は適切なプロンプト選択を案内

自動判定とチャットモード選択
-------------------------

### ファイル種別判定

1. プログラムコードかどうかを判定
2. 対象外の場合は適切なガイダンスを提供

### 言語判定とモード選択

- `.php`: [PHP開発者](../chatmodes/phper.chatmode.md)
- `.js`, `.mjs`, `.cjs`, `.ts`, `.jsx`, `.tsx`: [JavaScript開発者](../chatmodes/jser.chatmode.md)
- その他: 基本的なコードレビュー（未対応拡張子は基本品質チェックのみ）

稀な言語: SQL、シェルスクリプト等は適切なチャットモードを個別選択して対応

### セキュリティ観点の併用条件

以下に該当する場合は[セキュリティエンジニア](../chatmodes/security-engineer.chatmode.md)観点も併用：

- 認証・認可処理を含むコード（ログイン、権限チェック、トークン処理等）
- 外部入力を処理するコード（フォーム入力、API入力、ファイルアップロード等）
- データベース操作を含むコード（SQL文、ORM操作等）

### 出力形式

チャットモード選択後、以下を出力：

```
選択チャットモード: [モード名]
判定根拠: ファイル拡張子 (.拡張子)
適用規約: [言語固有のコーディング規約名]
```

**注意**: チャットモード参照に失敗した場合は基本的なコードレビューを実施する。

レビュー観点
-------------------------

### 基本品質チェック

- コーディング規約への準拠（PSR-12、ESLint等の言語固有標準）
    - 例: インデント、改行、括弧の位置、命名規則
- 命名規則と可読性
    - 例: 変数名が意味を表している、クラス名がPascalCase、メソッド名がcamelCase
- コメントとドキュメント品質
    - 例: Docコメントの存在、複雑なロジックの説明、TODOコメントの適切性

### セキュリティと安全性

- 入力検証とサニタイゼーション
    - 例: フォーム入力のバリデーション、HTMLエスケープ、SQLパラメータバインド
- 認証・認可の適切性
    - 例: セッション管理、権限チェック、トークン検証の実装
- 機密情報の取り扱い
    - 例: パスワードのハッシュ化、APIキーのハードコード回避、ログへの機密情報出力防止
- 一般的な脆弱性（SQLインジェクション、XSS等）
    - 例: 動的SQL文の回避、DOM操作時のエスケープ、ファイルアップロード制限

### パフォーマンスと効率性

- アルゴリズムとデータ構造の最適性
    - 例: ループの最適化、適切なデータ構造の選択、O(n)計算量の改善
- データベースクエリの効率性（主にPHP/ORM）
    - 例: N+1問題の回避、適切なインデックス利用、不要なカラム取得の回避
- メモリ使用量とリソース管理
    - 例: 大容量データの分割処理、ファイルハンドルのクローズ、メモリリークの防止

### 保守性とテスタビリティ

- モジュール設計と依存関係
    - 例: 単一責任原則の遵守、密結合の回避、依存性注入の適用
- エラーハンドリングの適切性
    - 例: try-catch文の適切な使用、例外クラスの使い分け、エラーログの記録
- テストの実装可能性
    - 例: メソッドの分割、モックしやすい設計、テストデータの準備容易性

出力要件
-------------------------

- 重要度の明示: 高（セキュリティ脆弱性、システム停止）/ 中（パフォーマンス問題、保守性）/ 低（規約違反、軽微な改善）
- 具体的な修正例: 修正前後のコード例と改善理由を併記
- 改善の優先順位: セキュリティ関連 → 機能不具合 → 可読性・保守性 → パフォーマンス
  - **注意**: 著しいパフォーマンス劣化を除き、可読性を優先する

出力フォーマット
-------------------------

[出力内容のサンプル](../examples/code_review.md)

制約事項
-------------------------

### 技術的制約

- ファイル種別の事前チェック必須（非プログラムファイルの不適切評価防止）
- 言語判定の省略禁止（不適切な評価基準による信頼性低下防止）
- セキュリティ評価の推測・断定禁止（不完全情報による誤判断リスク回避）
- 大幅なコード書き換えの無断実行禁止（既存機能への影響予測困難）

### 品質保証制約

- 抽象的で実行不可能な改善提案の禁止（具体性欠如による改善阻害防止）
- 重要度を明示しない問題点羅列の禁止（優先順位不明による効率低下防止）
- 言語固有特性を無視した汎用評価の禁止（実効性欠如防止）
- 可読性を犠牲にした過度なパフォーマンス最適化推奨の禁止（保守性重視）

### セキュリティ制約

- 機密情報や認証情報の表示・出力禁止（情報漏洩リスク防止）
- 推測による脆弱性の断定評価禁止（不正確評価による対策優先度誤認防止）

ファイル出力設定
-------------------------

### 出力条件

以下の場合にレビュー結果をファイル出力：
- 指摘事項が5件以上存在
- 重要度「高」の指摘が2件以上存在

### 命名規則

```
review_{パス情報}_{ファイル名}.md
```

- パス区切り文字（`/`）→ アンダースコア置換
- 拡張子除去、特殊文字→アンダースコア置換
- 出力先：プロジェクトルートディレクトリ

### 出力時の確認事項

1. 既存同名ファイルの上書き確認
2. 出力完了後の保存先パス明示
3. 大容量ファイル（1MB超）の事前確認

**注意**: ファイル出力に失敗した場合はコンソール出力で結果を表示する。
